// Data (mutable)
// `node.element` will be filled during `createNode`
// var treeData = [
// 	{
// 		name: 'Hecataeus_QMLTYPE_56_QML_87(0x12345678, "RootAppWindow")',
// 		element: null,
// 		children: [
// 			{
// 				name: 'MouseArea(0x12345678, "Clicker")',
// 				element: null,
// 				children: []
// 			},
// 			{
// 				name: 'MouseArea(0x12345678)',
// 				element: null,
// 				children: []
// 			}
// 		]
// 	}
// ];

// var mock = '{"objectName":"","type":"Hecataeus","children":[{"objectName":"","type":"QQmlConnections"},{"objectName":"","type":"QQmlSettings"},{"objectName":"","type":"QQmlComponent"},{"objectName":"","type":"QQmlComponent"},{"objectName":"","type":"QQmlTimer"},{"objectName":"","type":"QQuickLoader","children":[]},{"objectName":"","type":"LocaleItem","children":[{"objectName":"","type":"QQmlConnections"}]},{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"RegionUILoader","children":[{"objectName":"","type":"UpdateService"},{"objectName":"","type":"RegionManager"},{"objectName":"","type":"LocationItem"},{"objectName":"","type":"JamCollectorObject"},{"objectName":"","type":"Registry","children":[{"objectName":"","type":"RegistryItem"},{"objectName":"","type":"QQmlConnections"},{"objectName":"","type":"QQmlConnections"}]},{"objectName":"","type":"MapContainer","children":[{"objectName":"","type":"QQmlConnections"},{"objectName":"","type":"QQmlConnections"},{"objectName":"","type":"QObject"},{"objectName":"","type":"LowMemoryNotifier","children":[{"objectName":"","type":"QQuickItem","children":[{"objectName":"","type":"QQmlConnections"}]}]},{"objectName":"","type":"QQuickRectangle","children":[]},{"objectName":"","type":"QQuickRectangle","children":[]}]},{"objectName":"","type":"QQuickRectangle","children":[]},{"objectName":"","type":"Region","children":[{"objectName":"RegionEntryPointLoader","type":"QQuickLoader","children":[{"objectName":"","type":"QQuickItem","children":[{"objectName":"","type":"RegistryItem"},{"objectName":"","type":"QQmlTimer"},{"objectName":"AppWindowLoader","type":"QQuickLoader","children":[{"objectName":"","type":"MainWindow","children":[{"objectName":"","type":"RConnection"},{"objectName":"","type":"QObject"},{"objectName":"","type":"QObject"},{"objectName":"","type":"QObject"},{"objectName":"","type":"ErrorMessages"},{"objectName":"","type":"RConnection"},{"objectName":"","type":"QQmlConnections"},{"objectName":"","type":"QQmlConnections"},{"objectName":"","type":"QQmlConnections"},{"objectName":"","type":"RouteEditorItem"},{"objectName":"","type":"FollowDriverItem"},{"objectName":"","type":"BookmarkMapLayerObject"},{"objectName":"","type":"QQuickRectangle","children":[]},{"objectName":"","type":"QQuickMultiPointTouchArea","children":[]},{"objectName":"","type":"QQuickMouseArea","children":[]},{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"MapControl","children":[{"objectName":"","type":"IndoorItem"},{"objectName":"","type":"RouteMapLayerItem"},{"objectName":"","type":"LocationIndicatorItem"},{"objectName":"","type":"MapSelectionItem","children":[]},{"objectName":"","type":"MapPositionItem","children":[]},{"objectName":"","type":"MapObjectsShowItem","children":[]},{"objectName":"floorsControl","type":"IndoorViewItem","children":[{"objectName":"","type":"QQuickBorderImage","children":[]},{"objectName":"","type":"QQuickRectangle","children":[]},{"objectName":"","type":"QQuickRectangle","children":[{"objectName":"","type":"QQuickListView","children":[{"objectName":"","type":"QQuickItem","children":[]}]},{"objectName":"","type":"QQuickRectangle","children":[]},{"objectName":"","type":"QQuickRectangle","children":[]}]}]},{"objectName":"","type":"MapCompass","children":[{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"QQuickLoader","children":[]}]},{"objectName":"","type":"QQuickImage","children":[]},{"objectName":"","type":"QQuickRectangle","children":[]},{"objectName":"","type":"QQuickImage","children":[]},{"objectName":"","type":"QQuickMouseArea","children":[]}]},{"objectName":"trafficJam","type":"MapCongestion","children":[{"objectName":"","type":"JamManagerObject"},{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"MapCongestionStyle","children":[]}]},{"objectName":"","type":"QQuickItem","children":[{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"QQuickItem","children":[{"objectName":"","type":"RoundButton","children":[{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"RoundButtonStyle","children":[{"objectName":"","type":"QQuickImage","children":[]}]}]},{"objectName":"","type":"QQuickItem","children":[{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"QQuickRectangle","children":[]}]},{"objectName":"","type":"QQuickImage","children":[]}]}]},{"objectName":"","type":"QQuickMouseArea","children":[]}]},{"objectName":"","type":"QQuickRectangle","children":[]},{"objectName":"","type":"BaseLabel","children":[]}]}]},{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"QBrixComponent","children":[{"objectName":"","type":"QQmlTimer"},{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"QQuickLoader","children":[]}]},{"objectName":"","type":"QQuickCanvasItem","children":[]}]}]}]}]}]},{"objectName":"","type":"MapGeoposition","children":[{"objectName":"","type":"ScreenLockerItem"},{"objectName":"","type":"QQmlConnections"},{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"QQuickLoader","children":[]}]},{"objectName":"","type":"RoundButton","children":[{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"RoundButtonStyle","children":[{"objectName":"","type":"QQuickImage","children":[]}]}]},{"objectName":"","type":"QQuickItem","children":[{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"QQuickRectangle","children":[]}]},{"objectName":"","type":"QQuickImage","children":[]}]}]},{"objectName":"","type":"QQuickMouseArea","children":[]}]}]},{"objectName":"","type":"MapZoom","children":[{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"MapZoomStyle","children":[]}]},{"objectName":"","type":"QQuickItem","children":[{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"QQuickItem","children":[{"objectName":"","type":"QQuickMouseArea","children":[]}]}]},{"objectName":"","type":"QQuickLoader","children":[{"objectName":"zoomIn","type":"RoundButton","children":[{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"RoundButtonStyle","children":[{"objectName":"","type":"QQuickImage","children":[]}]}]},{"objectName":"","type":"QQuickItem","children":[{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"QQuickRectangle","children":[]}]},{"objectName":"","type":"QQuickImage","children":[]}]}]},{"objectName":"","type":"QQuickMouseArea","children":[]}]}]},{"objectName":"","type":"QQuickLoader","children":[{"objectName":"zoomOut","type":"RoundButton","children":[{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"RoundButtonStyle","children":[{"objectName":"","type":"QQuickImage","children":[]}]}]},{"objectName":"","type":"QQuickItem","children":[{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"QQuickRectangle","children":[]}]},{"objectName":"","type":"QQuickImage","children":[]}]}]},{"objectName":"","type":"QQuickMouseArea","children":[]}]}]}]}]}]},{"objectName":"","type":"QQuickItem","children":[{"objectName":"","type":"QQuickImage","children":[]},{"objectName":"","type":"QQuickMouseArea","children":[]}]},{"objectName":"","type":"QQuickRectangle","children":[]},{"objectName":"","type":"QQuickRectangle","children":[]},{"objectName":"","type":"QQuickRectangle","children":[]},{"objectName":"","type":"QQuickRectangle","children":[]}]},{"objectName":"","type":"QQuickShaderEffectSource","children":[]}]},{"objectName":"","type":"SideDrawer","children":[{"objectName":"","type":"QQuickLoader","children":[{"objectName":"leftSideBar","type":"SideBar","children":[{"objectName":"","type":"QQuickMultiPointTouchArea","children":[]},{"objectName":"","type":"QQuickMouseArea","children":[]},{"objectName":"","type":"QQuickFlickable","children":[{"objectName":"","type":"QQuickItem","children":[{"objectName":"","type":"QQuickColumn","children":[{"objectName":"","type":"QQuickItem","children":[{"objectName":"","type":"TextLabel","children":[]},{"objectName":"","type":"QQuickRectangle","children":[]}]},{"objectName":"","type":"QQuickItem","children":[{"objectName":"","type":"QQuickColumn","children":[{"objectName":"","type":"SBRegionMenuButton","children":[{"objectName":"","type":"QQuickMouseArea","children":[]},{"objectName":"","type":"QQuickItem","children":[{"objectName":"","type":"QQuickImage","children":[]},{"objectName":"","type":"TextLabel","children":[]},{"objectName":"","type":"QQuickRectangle","children":[{"objectName":"","type":"TextLabel","children":[]}]},{"objectName":"","type":"QQuickRectangle","children":[]}]}]},{"objectName":"","type":"SBRegionMenuButton","children":[{"objectName":"","type":"RouteAgentItem"},{"objectName":"","type":"QQuickMouseArea","children":[]},{"objectName":"","type":"QQuickItem","children":[{"objectName":"","type":"QQuickImage","children":[]},{"objectName":"","type":"TextLabel","children":[]},{"objectName":"","type":"QQuickRectangle","children":[{"objectName":"","type":"TextLabel","children":[]}]},{"objectName":"","type":"QQuickRectangle","children":[]}]}]},{"objectName":"","type":"SBRegionMenuButton","children":[{"objectName":"","type":"QQuickMouseArea","children":[]},{"objectName":"","type":"QQuickItem","children":[{"objectName":"","type":"QQuickImage","children":[]},{"objectName":"","type":"TextLabel","children":[]},{"objectName":"","type":"QQuickRectangle","children":[{"objectName":"","type":"TextLabel","children":[]}]},{"objectName":"","type":"QQuickRectangle","children":[]}]}]},{"objectName":"","type":"SBRegionMenuButton","children":[{"objectName":"","type":"QQuickMouseArea","children":[]},{"objectName":"","type":"QQuickItem","children":[{"objectName":"","type":"QQuickImage","children":[]},{"objectName":"","type":"TextLabel","children":[]},{"objectName":"","type":"QQuickRectangle","children":[{"objectName":"","type":"TextLabel","children":[]}]},{"objectName":"","type":"QQuickRectangle","children":[]}]}]}]},{"objectName":"","type":"QQuickRectangle","children":[]}]},{"objectName":"","type":"QQuickItem","children":[{"objectName":"","type":"QQuickColumn","children":[{"objectName":"","type":"SBAppMenuButton","children":[{"objectName":"","type":"QQuickMouseArea","children":[]},{"objectName":"","type":"QQuickItem","children":[{"objectName":"","type":"TextLabel","children":[]}]}]},{"objectName":"","type":"SBAppMenuButton","children":[{"objectName":"","type":"QQuickMouseArea","children":[]},{"objectName":"","type":"QQuickItem","children":[{"objectName":"","type":"TextLabel","children":[]}]}]},{"objectName":"","type":"SBAppMenuButton","children":[{"objectName":"","type":"QQuickMouseArea","children":[]},{"objectName":"","type":"QQuickItem","children":[{"objectName":"","type":"TextLabel","children":[]}]}]},{"objectName":"","type":"SBAppMenuButton","children":[{"objectName":"","type":"QQuickMouseArea","children":[]},{"objectName":"","type":"QQuickItem","children":[{"objectName":"","type":"TextLabel","children":[]}]}]}]}]}]},{"objectName":"","type":"QQuickMouseArea","children":[]}]}]}]}]}]},{"objectName":"keyGrabber__mainWindow","type":"QQuickItem","children":[]},{"objectName":"","type":"AppToast","children":[{"objectName":"","type":"QObject"},{"objectName":"","type":"QObject"},{"objectName":"","type":"ToasterHelperItem"}]},{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"QQuickItem","children":[{"objectName":"","type":"QQmlConnections"},{"objectName":"","type":"QQmlConnections"}]}]},{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"VendorRegistrationItem","children":[]}]},{"objectName":"","type":"QQuickLoader","children":[]},{"objectName":"","type":"QQuickLoader","children":[]},{"objectName":"mainBssCollector","type":"BssCollector","children":[{"objectName":"","type":"QQmlConnections"}]},{"objectName":"","type":"BookmarkManagerItem","children":[]},{"objectName":"MainWindow/StackView","type":"ExtendedStackView","children":[{"objectName":"","type":"QObject"},{"objectName":"cityPage","type":"CityPage","children":[{"objectName":"","type":"RConnection"},{"objectName":"","type":"QObject"},{"objectName":"","type":"QQmlConnections"},{"objectName":"","type":"QQmlConnections"},{"objectName":"","type":"QQmlConnections"},{"objectName":"","type":"QQmlConnections"},{"objectName":"","type":"QQmlConnections"},{"objectName":"","type":"QQuickRectangle","children":[]},{"objectName":"","type":"QQuickMultiPointTouchArea","children":[]},{"objectName":"","type":"QQuickMouseArea","children":[]},{"objectName":"","type":"GlideContainer","children":[{"objectName":"CityPage/StackView","type":"ExtendedStackView","children":[{"objectName":"dashboardPage","type":"DashboardPage","children":[{"objectName":"","type":"RConnection"},{"objectName":"","type":"QObject"},{"objectName":"","type":"QQuickNumberAnimation"},{"objectName":"","type":"QQuickNumberAnimation"},{"objectName":"","type":"QQuickYAnimator"},{"objectName":"","type":"QQuickRectangle","children":[]},{"objectName":"","type":"QQuickMultiPointTouchArea","children":[]},{"objectName":"","type":"QQuickMouseArea","children":[]},{"objectName":"pieMenu","type":"MapDashboard","children":[{"objectName":"","type":"QQuickImage","children":[]},{"objectName":"","type":"QQuickRectangle","children":[]},{"objectName":"","type":"ImageMask","children":[{"objectName":"","type":"QQuickImage","children":[]}]},{"objectName":"","type":"QQuickImage","children":[]},{"objectName":"","type":"QQuickRepeater","children":[]},{"objectName":"","type":"QQuickMouseArea","children":[]}]}]}]}]},{"objectName":"cityBssCollector","type":"BssCollector","children":[]},{"objectName":"","type":"MovableHeader","children":[{"objectName":"topBar","type":"TopBar","children":[{"objectName":"","type":"QQmlTimer"},{"objectName":"","type":"QQmlConnections"},{"objectName":"","type":"QQmlConnections"},{"objectName":"","type":"QQuickMultiPointTouchArea","children":[]},{"objectName":"","type":"QQuickMouseArea","children":[]},{"objectName":"","type":"QQuickLoader","children":[]},{"objectName":"","type":"QQuickLoader","children":[{"objectName":"","type":"QQmlConnections"}]},{"objectName":"","type":"SearchTopBarPanel","children":[{"objectName":"","type":"QObject"},{"objectName":"","type":"QQmlTimer"},{"objectName":"","type":"QQuickBorderImage","children":[]},{"objectName":"","type":"QQuickRectangle","children":[]},{"objectName":"","type":"SearchInput","children":[{"objectName":"","type":"QQmlConnections"},{"objectName":"","type":"QQmlTimer"},{"objectName":"SearchInput/Menu","type":"QQuickItem","children":[{"objectName":"","type":"SandwichBackButton","children":[{"objectName":"","type":"QQuickParallelAnimation"},{"objectName":"","type":"QQuickNumberAnimation"},{"objectName":"","type":"QQuickRectangle","children":[]},{"objectName":"","type":"QQuickRectangle","children":[]},{"objectName":"","type":"QQuickRectangle","children":[]},{"objectName":"","type":"QQuickRectangle","children":[]}]},{"objectName":"asdasdasdasd","type":"QQuickMouseArea","children":[]}]},{"objectName":"__textEditLoader","type":"TextEditItem","children":[{"objectName":"__textEditAndroid","type":"TextEditAndroidNative","children":[{"objectName":"","type":"QQmlConnections"}]}]},{"objectName":"","type":"QQuickRectangle","children":[{"objectName":"","type":"QQuickImage","children":[]},{"objectName":"","type":"QQuickMouseArea","children":[]}]}]}]}]}]}]}]},{"objectName":"","type":"QQuickRectangle","children":[{"objectName":"","type":"QQuickMultiPointTouchArea","children":[]},{"objectName":"","type":"QQuickMouseArea","children":[]}]}]}]}]}]}]}]}]}]}, "id": "undefined"}';

var treeData = {};
var matchedNodes = [];
var currentResultIndex = 0;

// lastSelector used to evade same finding work. It is not a valid selector to make a request.
var lastSelector = {
	query: '',
	index: 0
};
function updateLastSelector(query, index) {
	lastSelector.query = query;
	lastSelector.index = index;
}

// currentSelector used to make requests. It is a valid selector.
var currentSelector = {
	query: '',
	index: 0
};
function updateCurrentSelector(query, index) {
	currentSelector.query = query;
	currentSelector.index = index;
}

// [{propertyName: prop, element: propElement}]
var currentProperties = [];

/*
	name <String>
		Default type: 'MouseArea(0x12345678)'
		Default type + objectName: 'MouseArea(0x12345678, "Clicker")'
		Custom type: 'Hecataeus_QMLTYPE_56_QML_87(0x12345678)'
		Custom type + objectName: 'Hecataeus_QMLTYPE_56_QML_87(0x12345678, "RootAppWindow")'
*/
function getNodeData(name) {
	var parts = name.split('(');
	var type = parts[0].split('_')[0];
	var objectName = parts[1].split('"');
	objectName = objectName.length === 3
		? objectName[1]
		: "";
	return {
		type: type,
		objectName: objectName
	};
}


// WebSocket
var ws = new WebSocket('ws://localhost:12345');
ws.onmessage = function(event) {
	var data = JSON.parse(event.data);
	console.log(data);

	switch (data.method) {
		case 'listElements':
			updateTree(data.result);
			break;
		case 'listProperties':
			if (data.result instanceof Array && data.result.length) {
				updateProperties(data.result);
			}
			break;
		case 'getProperty':
			if (data.result) {
				updateProperty(data.result.key, JSON.stringify(data.result.value));
			}
			break;
		case 'setProperty':
			break;
		default:
			console.warn('There is no handler for', data.method)
			return;
	}
};
ws.onerror = function() {
	console.error(event);
};
ws.onopen = function() {
	// base = '{"jsonrpc": "2.0", "method": "setProperty", "params": ["SandwichBackButton", "color", "blue"]}'
	listElements();
};


function listElements() {
	var request = {
		jsonrpc: '2.0',
		method: 'listElements'
	};
	ws.send(JSON.stringify(request));
}
function listProperties(selector, index) {
	var request = {
		jsonrpc: '2.0',
		method: 'listProperties',
		params: [selector, index]
	};
	ws.send(JSON.stringify(request));
}
function getProperty(selector, index, name) {
	var request = {
		jsonrpc: '2.0',
		method: 'getProperty',
		params: [selector, index, name]
	};
	ws.send(JSON.stringify(request));
}
function setProperty(selector, index, name, value) {
	var request = {
		jsonrpc: '2.0',
		method: 'setProperty',
		params: [selector, index, name, value]
	};
	ws.send(JSON.stringify(request));
}
function addBorderToElement(selector, index) {
	var request = {
		jsonrpc: '2.0',
		method: 'addBorderToElement',
		params: [selector, index]
	};
	ws.send(JSON.stringify(request));
}


// Command Line
var input = document.querySelectorAll('.input')[0];
input.addEventListener('keyup', handleInput);
input.addEventListener('change', handleInput);
input.addEventListener('keydown', function(event) {
	if (event.keyCode === 38) {
		event.preventDefault();
		return handleUpDownArrows(true);
	} else if (event.keyCode === 40) {
		event.preventDefault();
		return handleUpDownArrows(false);
	}
});
// example: "DirectoryPage[2]"
var selectorRegexp = /([^\[\]]+)(\[([0-9]+)\])?/;
function handleInput(event) {
	// up and down arrows are handled in keyDown
	if (event.keyCode === 38 || event.keyCode === 40) {
		return;
	}

	var query = event.target.value;
	// Protect from repeatedly emitting input.changed with empty input.value
	if (query === lastSelector.query && 0 === lastSelector.index) {
		return;
	}
	if (!query) {
		updateLastSelector('', 0);
		unmatchElements(matchedNodes);
		matchedNodes = [];
		updateResults(matchedNodes);
		updateProperties([]);
		return;
	}

	var queryParts = query.split('.');
	if (queryParts.length === 1) {
		var q = queryParts[0];
		var r = selectorRegexp.exec(q);
		var i = r[3] || 0;
		q = r[1];

		var searchType = q.startsWith('#')
			? 'objectName'
			: 'type';

		// query could be #ObjectName or Type, so cut the # and lowerCase it
		if (searchType === 'objectName') {
			q = q.substr(1);
		}
		q = q.toLowerCase();

		if (q === lastSelector.query && i === lastSelector.index) {
			return;
		}
		updateLastSelector(q, i);
		var nodes = q
			? findBy(treeData, searchType, q)
			: [];

		if (!nodes.length) {
			unmatchElements(matchedNodes);
			matchedNodes = nodes;
			return;
		}

		matchedNodes = nodes;
		updateResults(matchedNodes);

		var selectedNode = matchedNodes[i];
		var selector = getSelector(selectedNode, searchType);
		updateCurrentSelector(selector, i);

		addBorderToElement(selector, i);
		listProperties(selector, i);

		matchedNodes.forEach(function(node) {
			match(node.element, searchType, node[searchType], query);
		});
		match(selectedNode.element, searchType, selectedNode[searchType], query, true);

		selectedNode.element.scrollIntoView();
	}
}
function handleUpDownArrows(up) {
	if (matchedNodes.length > 1) {
		var newResultIndex = up
			? currentResultIndex - 1 < 0
				? matchedNodes.length - 1
				: currentResultIndex - 1
			: currentResultIndex + 1 > matchedNodes.length - 1
				? 0
				: currentResultIndex + 1;
		updateResultSelected(resultsElement.children, currentResultIndex, newResultIndex);
		currentResultIndex = newResultIndex;
	}
}
function getSelector(node, searchType, index) {
	var selectorIndex = index === undefined
		? ''
		: '[' + index + ']'
	return searchType === 'objectName'
		? '#' + node.objectName + selectorIndex
		: node.type + selectorIndex;
}

function findBy(node, searchType, query, results) {
	results = results || [];
	if (node[searchType].toLowerCase().startsWith(query)) {
		results.push(node);
		match(node.element, searchType, node[searchType], query);
	} else if (matchedNodes.indexOf(node) !== -1) {
		unmatch(node.element, searchType, node[searchType]);
	}
	if (node.children) {
		node.children.forEach(function(child) {
			findBy(child, searchType, query, results);
		});
	}
	return results;
}


function updateTree(elements) {
	treeData = elements;
	createNode(treeElement, treeData);
}
function checkResults(visualType, nodeData) {
	var result = [];
	var searchType = nodeData.objectName ? 'objectName' : 'type';

	if (visualType === 'result' && matchedNodes.length) {
		result = matchedNodes.filter(function(matchedNode) {
			return matchedNode[searchType] === nodeData[searchType];
		});
	}

	input.value = getSelector(
		nodeData,
		searchType,
		result.length > 1
			? result.indexOf(nodeData)
			: undefined);
	input.dispatchEvent(new Event('change'));

	return result;
}


// DOM
var treeElement = document.querySelectorAll('.tree')[0];
var resultsElement = document.querySelectorAll('.results')[0];
var resultsCountElement = document.querySelectorAll('.results-count-number')[0];
var propertiesElement = document.querySelectorAll('.properties')[0];
var propertiesCountElement = document.querySelectorAll('.properties-count-number')[0];


/*
	nodes {
		name: <String>,
		children: [<Node>]
	}
*/
function createNode(parent, node, deepness) {
	deepness = deepness || 0;

	var fragment = document.createDocumentFragment();
	node.element = createNodeElement(node, 'tree-node', deepness);
	fragment.appendChild(node.element);

	if (node.children) {
		node.children.forEach(function(child) {
			createNode(fragment, child, deepness + 1);
		});
	}

	parent.appendChild(fragment);
}
/*
	nodeData {
		type: <String>,
		[objectName: <String>]
	}
	visualType <String> ('tree-node'|'result')
	deepness <Number>
*/
function createNodeElement(nodeData, visualType, deepness) {
	var node = document.createElement('div');
	addClass(node, visualType);

	var space = document.createElement('span');
	addClass(space, 'space');
	space.innerText = new Array(deepness * 4).join(' ');
	node.appendChild(space);

	var type = document.createElement('span');
	addClass(type, 'type');
	type.innerText = nodeData.type;
	node.appendChild(type);

	if (nodeData.objectName) {
		var objectName = document.createElement('span');
		addClass(objectName, 'objectName');
		objectName.innerText = nodeData.objectName;
		node.appendChild(objectName);
	}

	node.addEventListener('click', function(event) {
		var results = checkResults(visualType, nodeData);
	});

	return node;
}
function updateResults(nodes) {
	if (!nodes.length) {
		resultsElement.innerHTML = '';
	} else {
		var fragment = document.createDocumentFragment();
		nodes.forEach(function(node) {
			fragment.appendChild(createNodeElement(node, 'result', 0));
		});
		resultsElement.innerHTML = '';
		resultsElement.appendChild(fragment);
	}

	resultsCountElement.innerText = nodes.length;
}
function updateProperties(properties) {
	currentProperties = [];

	if (!properties.length) {
		propertiesElement.innerHTML = '';
	} else {
		var fragment = document.createDocumentFragment();
		var filteredProperties = properties.filter(function(prop) {
			return !prop.endsWith('Changed');
		});
		filteredProperties.forEach(function(prop) {
			var propElement = document.createElement('div');
			addClass(propElement, 'property');

			var propKey = document.createElement('span');
			addClass(propKey, 'property__key');
			propKey.innerText = prop;
			propKey.addEventListener('click', function(event) {
				getProperty(currentSelector.query, currentSelector.index, prop);
			});

			var propValue = document.createElement('span');
			addClass(propValue, 'property__value');
			propValue.setAttribute('contenteditable', 'true');
			propValue.addEventListener('keydown', function(event) {
				if (event.keyCode === 13) {
					event.preventDefault();
					setProperty(currentSelector.query, currentSelector.index, prop, event.target.textContent);
				}
			});
			propValue.addEventListener('blur', function(event) {
				setProperty(currentSelector.query, currentSelector.index, prop, event.target.textContent);
			});

			propElement.appendChild(propKey);
			propElement.appendChild(propValue);

			fragment.appendChild(propElement);

			currentProperties.push({propertyName: prop, element: propElement});
		});
		propertiesElement.innerHTML = '';
		propertiesElement.appendChild(fragment);
	}

	propertiesCountElement.innerText = properties.length;
}
function updateProperty(key, value) {
	currentProperties.find(function(prop) {
		return prop.propertyName === key;
	}).element.children[1].innerText = value;
}
function addClass(element, className) {
	var classes = element.className.split(' ');
	if (!(className in classes)) {
		classes.push(className);
		element.className = classes.join(' ');
	}
}
function removeClass(element, className) {
	var classes = element.className.split(' ');
	var index = classes.indexOf(className);
	if (index !== -1) {
		classes.splice(index, 1);
		element.className = classes.join(' ');
	}
}
/*
	element <div .node>
				<span .space>
				<span .type>
				[<span .objectName>]
	searchType <String> 'type'|'objectName'
	string <String>
	query <String>
	select <Bool>
*/
function match(element, searchType, string, query, select) {
	var matchClass = select ? 'selected' : 'match';
	var childIndex = searchType === 'type' ? 1 : 2;
	var typeElement = element.children[childIndex];
	typeElement.innerHTML = '<span class="' + matchClass + '">' + string.substr(0, query.length) + '</span>' + string.substr(query.length);
}
function unmatch(element, searchType, string) {
	var childIndex = searchType === 'type' ? 1 : 2;
	var typeElement = element.children[childIndex];
	typeElement.innerHTML = string;
}
function unmatchElements(nodes) {
	nodes.forEach(function(node) {
		node.element.children[1].innerText = node.type;
		if (node.objectName) {
			node.element.children[2].innerText = node.objectName;
		}
	});
}

function updateResultSelected(resultDOMElements, currentIndex, newIndex) {
	removeClass(resultDOMElements[currentIndex], 'selected');
	addClass(resultDOMElements[newIndex], 'selected');
}

// Program
// createNode(treeElement, treeData);
console.info('Greetings, my dear v4android developer!');
console.info('Make sure to run: adb forward tcp:12345 tcp:12345');
console.info('Make sure to add v4option: -G');
